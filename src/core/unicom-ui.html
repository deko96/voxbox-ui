<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="unicom-ui">
	<template>
		<style>
		:host {
            height: 100%;
            display: flex;
        }
		:host *[hidden] {
			display: none;
		}
		iframe {
			width: 100%;
			height: 100%;
			display: flex;
			border: 0;
		}

		.no-items {
            display: flex;
            width: 100%;
            justify-content: center;
            align-items: center;
        }

        .no-items > paper-material {
            text-align: center;
            margin-bottom: 100px;
            padding: 60px;
            width: 400px;
            background: white;
        }

	</style>
	<iframe id="unicom" src="/unicom/voxbox.html" hidden$="[[!_showTextContainer(loaded, error)]]"></iframe>
	
	<template is="dom-if" if="[[_showTextContainer(loaded, error)]]">
		<div class="no-items">
			<paper-material>
				<template is="dom-if" if="[[!error]]">
					<paper-spinner-lite active></paper-spinner-lite>
				</template>
				<template is="dom-if" if="[[error]]">
					[[error]]
				</template>
			</paper-material>
		</div>
	</template>

</template>
<script>

	Polymer({

		is: 'unicom-ui',

		properties: {
			unicom: Object,
			config: Object,
			error: {
				type: String,
				value: null
			},
			loaded: {
				type: Boolean,
				value: false
			}
		},

		ready: function() {
			if (!this.config || (!this.config.server || !this.config.user || !this.config.pass)) {
				this.error = 'Failed to setup Unicom. Please check your server configuration and refresh the page!';
				this.loaded = true;
			} else {
				this.error = null;
				this.unicom = this.$.unicom || this.$$('#unicom');
				//return console.log(this.unicom, this.$.unicom, this.$$('#unicom'));
				this.unicom.onload = this._onLoad.bind(this);
				window.onmessage = function(e) {
					if(e.origin && e.origin.indexOf(window.location.hostname) !== -1) {
						this._onMessage(e.data);
					}
				}.bind(this);
			}
		},

		_onLoad: function(e) {
			if (!this.config.server) {
				this.config.server = window.location.host;
			}
			this.authenticate(this.config);
		},

		_onMessage: function(e) {
			switch(e.event) {
				case 'unicom:ready':
					this.error = null;
					this.loaded = true;
					break;
				case 'unicom:destroy':
					this.loaded = false;
					break;
			}
	  },

	  _showTextContainer: function(loaded, error) {
		  return (loaded && error && error.length) || !loaded;
	  },

	  postMessage: function(message) {
	  	this.unicom.contentWindow.postMessage(message, '*');
	  },

	  authenticate: function(data) {
	  	this.postMessage({
	  		event: 'user:auth',
	  		data: data
	  	});
	  }
	});

</script>
</dom-module>
